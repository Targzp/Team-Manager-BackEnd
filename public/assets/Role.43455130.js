var e=Object.defineProperty,t=Object.defineProperties,l=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,i=(t,l,a)=>l in t?e(t,l,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[l]=a,s=(e,t)=>{for(var l in t||(t={}))o.call(t,l)&&i(e,l,t[l]);if(a)for(var l of a(t))r.call(t,l)&&i(e,l,t[l]);return e};import{u as n}from"./index.605a31b6.js";import{r as d,O as m,o as h,c,d as u,e as p,w as g,P as f,F as w,a as y,b,g as k,f as C,t as _}from"./vendor.b1d65a4d.js";const F={name:"role",data(){return{roleList:[],queryForm:{},roleForm:{remark:""},showModel:!1,showPermission:!1,curRoleId:"",curRoleName:"",menuList:[],actionMap:{},action:"",pager:{pageNum:1,pageSize:10},columns:[{label:"角色名称",prop:"roleName",align:"center"},{label:"备注",prop:"remark",width:250,align:"center"},{label:"权限列表",prop:"permissionList",align:"center",formatter:(e,t,l)=>{let a=[];return(l.halfCheckedKeys||[]).map((e=>{this.actionMap[e]&&a.push(this.actionMap[e])})),a.join(",")}},{label:"创建时间",prop:"createTime",width:250,align:"center",formatter:(e,t,l)=>n.formateDate(new Date(l))}],rules:{roleName:[{required:!0,message:"请输入角色名称",trigger:"blur"}]}}},mounted(){this.getRoleList(),this.getMenuList()},methods:{async getRoleList(){try{let e=s(s({},this.queryForm),this.pager);const{list:t,page:l}=await this.$api.getRoleList(e);this.roleList=t,this.pager.total=l.total}catch(e){throw new Error(e)}},async getMenuList(){try{const e=await this.$api.getMenuList({menuState:1});this.menuList=e,this.getActionMap(e)}catch(e){throw new Error(e)}},getActionMap(e){let t={};const l=e=>{e.map((e=>{e.children&&e.action&&(t[e._id]=e.menuName),e.children&&!e.action&&l(e.children)}))};l(e),this.actionMap=t},handleCurrentChange(e){this.pager.pageNum=e,this.getRoleList()},handleQuery(){this.getRoleList()},handleReset(e){this.$refs[e].resetFields()},handleAdd(){this.showModel=!0,this.action="create"},handleEdit(e){this.showModel=!0,this.$nextTick((()=>{this.action="edit";let{_id:t,roleName:l,remark:a}=e;this.roleForm={_id:t,roleName:l,remark:a}}))},async handleDelete(e){const t=e._id;try{await this.$api.roleSubmit({_id:t,action:"delete"}),this.$message.success("删除成功"),this.getRoleList()}catch(l){throw new Error(l)}},handleClose(){this.showModel=!1,this.handleReset("dialogForm")},handleSubmit(){this.$refs.dialogForm.validate((async e=>{if(e){let e=this.action,r=(a=s({},this.roleForm),t(a,l({action:e})));try{await this.$api.roleSubmit(r);this.showModel=!1,this.$message.success("操作成功"),this.handleReset("dialogForm"),this.getRoleList()}catch(o){throw new Error(o)}}var a}))},handlePermission(e){this.showPermission=!0,this.$nextTick((()=>{this.curRoleName=e.roleName,this.curRoleId=e._id;let{checkedKeys:t}=e.permissionList;this.$refs.permissionTree.setCheckedKeys(t)}))},async handlePermissionSubmit(){let e=this.$refs.permissionTree.getCheckedNodes(),t=this.$refs.permissionTree.getHalfCheckedKeys(),l=[],a=[];e.map((e=>{e.children?a.push(e._id):l.push(e._id)}));let o={_id:this.curRoleId,permissionList:{checkedKeys:l,halfCheckedKeys:a.concat(t)}};try{await this.$api.updatePermission(o),this.showPermission=!1,this.$message.success("设置成功"),this.getRoleList()}catch(r){throw new Error(r)}}}},L={class:"role-manager"},N={class:"query-form"},R=C("查询"),P=C("重置"),M={class:"base-table"},V={class:"action"},$=C("创建"),v=C("编辑"),x=C("设置权限"),O=C("删除"),S={class:"dialog-footer"},j=C("取 消"),E=C("确 定"),q={class:"dialog-footer"},z=C("取 消"),T=C("确 定");F.render=function(e,t,l,a,o,r){const i=d("el-input"),s=d("el-form-item"),n=d("el-button"),F=d("el-form"),K=d("el-table-column"),D=d("el-table"),U=d("el-pagination"),A=d("el-dialog"),I=d("el-tree"),Q=m("has");return h(),c("div",L,[u("div",N,[p(F,{inline:!0,model:o.queryForm,ref:"validateForm"},{default:g((()=>[p(s,{label:"角色名称",prop:"roleName"},{default:g((()=>[p(i,{modelValue:o.queryForm.roleName,"onUpdate:modelValue":t[0]||(t[0]=e=>o.queryForm.roleName=e),placeholder:"请输入角色名称"},null,8,["modelValue"])])),_:1}),p(s,null,{default:g((()=>[p(n,{type:"primary",onClick:r.handleQuery},{default:g((()=>[R])),_:1},8,["onClick"]),p(n,{onClick:t[1]||(t[1]=()=>r.handleReset("validateForm"))},{default:g((()=>[P])),_:1})])),_:1})])),_:1},8,["model"])]),u("div",M,[u("div",V,[f(p(n,{type:"primary",onClick:r.handleAdd},{default:g((()=>[$])),_:1},8,["onClick"]),[[Q,"role-create"]])]),p(D,{"max-height":"350",data:o.roleList},{default:g((()=>[(h(!0),c(w,null,y(o.columns,(e=>(h(),b(K,{key:e.prop,prop:e.prop,label:e.label,width:e.width,align:e.align,formatter:e.formatter},null,8,["prop","label","width","align","formatter"])))),128)),p(K,{label:"操作",width:"250",align:"center"},{default:g((e=>[f(p(n,{size:"mini",plain:"",onClick:t=>r.handleEdit(e.row)},{default:g((()=>[v])),_:2},1032,["onClick"]),[[Q,"role-edit"]]),f(p(n,{size:"mini",type:"primary",onClick:t=>r.handlePermission(e.row)},{default:g((()=>[x])),_:2},1032,["onClick"]),[[Q,"role-setting"]]),f(p(n,{type:"danger",size:"mini",onClick:t=>r.handleDelete(e.row)},{default:g((()=>[O])),_:2},1032,["onClick"]),[[Q,"role-delete"]])])),_:1})])),_:1},8,["data"]),p(U,{class:"pagination",layout:"prev, pager, next",total:o.pager.total,"page-size":o.pager.pageSize,onCurrentChange:r.handleCurrentChange},null,8,["total","page-size","onCurrentChange"])]),p(A,{title:"edit"==o.action?"角色编辑":"角色新增",modelValue:o.showModel,"onUpdate:modelValue":t[4]||(t[4]=e=>o.showModel=e),"close-on-click-modal":!1,"show-close":!1,"close-on-press-escape":!1,center:!0},{footer:g((()=>[u("span",S,[p(n,{onClick:r.handleClose},{default:g((()=>[j])),_:1},8,["onClick"]),p(n,{type:"primary",onClick:r.handleSubmit},{default:g((()=>[E])),_:1},8,["onClick"])])])),default:g((()=>[p(F,{ref:"dialogForm",model:o.roleForm,"label-width":"100px",rules:o.rules},{default:g((()=>[p(s,{label:"角色名称",prop:"roleName"},{default:g((()=>[p(i,{modelValue:o.roleForm.roleName,"onUpdate:modelValue":t[2]||(t[2]=e=>o.roleForm.roleName=e),placeholder:"请输入角色名称"},null,8,["modelValue"])])),_:1}),p(s,{label:"备注",prop:"remark"},{default:g((()=>[p(i,{type:"textarea",rows:2,modelValue:o.roleForm.remark,"onUpdate:modelValue":t[3]||(t[3]=e=>o.roleForm.remark=e),placeholder:"请输入备注"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])),_:1},8,["title","modelValue"]),k(" 权限弹框 "),p(A,{title:"设置权限",modelValue:o.showPermission,"onUpdate:modelValue":t[6]||(t[6]=e=>o.showPermission=e),"close-on-click-modal":!1,"show-close":!1,"close-on-press-escape":!1,center:!0},{footer:g((()=>[u("span",q,[p(n,{onClick:t[5]||(t[5]=e=>this.showPermission=!1)},{default:g((()=>[z])),_:1}),p(n,{type:"primary",onClick:r.handlePermissionSubmit},{default:g((()=>[T])),_:1},8,["onClick"])])])),default:g((()=>[p(F,{"label-width":"100px"},{default:g((()=>[p(s,{label:"角色名称"},{default:g((()=>[C(_(o.curRoleName),1)])),_:1}),p(s,{label:"选择权限"},{default:g((()=>[p(I,{ref:"permissionTree",data:o.menuList,"show-checkbox":"","node-key":"_id","default-expand-all":"",props:{label:"menuName"}},null,8,["data"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])};export{F as default};
